<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Head content here -->
</head>
<body>
  <!-- Body content up to monthly table -->
  <script>
    // ... previous JavaScript functions

    function updateMonthlyTable() {
        const tbody = document.getElementById('monthlyTableBody');
        tbody.innerHTML = '';

        if (appData.expenses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="no-data">No expenses added yet</td></tr>';
            return;
        }

        const categoryData = {};
        const totalExpenses = appData.expenses.reduce((sum, exp) => sum + exp.amount, 0);

        appData.expenses.forEach(expense => {
            if (!categoryData[expense.category]) {
                categoryData[expense.category] = {
                    total: 0,
                    count: 0
                };
            }
            categoryData[expense.category].total += expense.amount;
            categoryData[expense.category].count += 1;
        });

        Object.entries(categoryData).forEach(([category, data]) => {
            const percentage = totalExpenses > 0 ? ((data.total / totalExpenses) * 100).toFixed(1) : 0;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${category}</td>
                <td class="amount-cell">â‚¹${data.total.toLocaleString()}</td>
                <td>${percentage}%</td>
                <td>${data.count}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function checkBudgetAlerts() {
        const total = appData.expenses.reduce((sum, exp) => sum + exp.amount, 0);
        const percent = (total / appData.budget) * 100;

        if (percent >= 90 && !appData.budgetAlerts.ninety) {
            showAlert('You have used 90% of your budget!', 'danger');
            appData.budgetAlerts.ninety = true;
        } else if (percent >= 75 && !appData.budgetAlerts.seventyFive) {
            showAlert('You have used 75% of your budget!', 'warning');
            appData.budgetAlerts.seventyFive = true;
        } else if (percent >= 50 && !appData.budgetAlerts.fifty) {
            showAlert('You have used 50% of your budget!', 'warning');
            appData.budgetAlerts.fifty = true;
        }
    }

    function showAlert(message, type) {
        const alertBox = document.createElement('div');
        alertBox.className = `alert ${type}`;
        alertBox.textContent = message;
        document.body.appendChild(alertBox);

        setTimeout(() => {
            alertBox.remove();
        }, 4000);
    }

    function downloadCSV() {
        const rows = [['Date', 'Vendor', 'Category', 'Amount']];
        appData.expenses.forEach(exp => {
            rows.push([exp.date, exp.vendor, exp.category, exp.amount]);
        });

        let csvContent = 'data:text/csv;charset=utf-8,' + rows.map(e => e.join(",")).join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `expenses_${appData.currentMonth}_${appData.currentYear}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function resetApp() {
        if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
            appData = {
                budget: 0,
                expenses: [],
                budgetAlerts: {
                    fifty: false,
                    seventyFive: false,
                    ninety: false
                },
                currentMonth: '',
                currentYear: 0
            };
            location.reload();
        }
    }

    function syncToGoogleSheets() {
        fetch(GOOGLE_SHEETS_URL, {
            method: 'POST',
            body: JSON.stringify(appData),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => showAlert('Data synced to Google Sheets!', 'success'))
        .catch(err => showAlert('Error syncing data.', 'danger'));
    }

    window.onload = initApp;
  </script>
</body>
</html>
